<!DOCTYPE HTML>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Collection: mult test</title>
	<link rel="stylesheet" href="../qunit.css" type="text/css">
	<script src="../jquery.js"></script>
	<script type="text/javascript" src="../qunit.js"></script>
	<script type="text/javascript" src="../../collection.js"></script>
	<script type="text/javascript">
		$(function () {
			module('core');
			test('forEach (with array)', function () {
				equal($C([1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}).get()[0], 2, 'simple forEach');
				equal($C([1, 2, 3, 4]).forEach(':data[key] += 1').get()[0], 2, 'simple forEach with string expression');
				
				equal($C().pushCollection('test', [1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', 'test').getCollection('test')[0], 2, 'id -> test');
				
				equal($C().pushSetCollection('test', [1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', 'active').getCollection('test')[0], 2, 'id -> active');
				
				equal($C([1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', '', false).get()[1], 2, 'mult -> false');
				
				equal((function () {
					var db = $C([1, 2, 3, 4]).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2);
					
					return db.get()[1] === 3 &&  db.get()[2] === 3;
				})(), true, 'count -> 2');
				
				equal((function () {
					var db = $C([1, 2, 3, 4]).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2, 1).get();
					
					return db[1] === 3 && db[2] === 4;
				})(), true, 'count -> 2, from -> 1');
				
				equal((function () {
					var db = $C([1, 2, 3, 4]).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2, 1, '', true);
					
					return db.get()[1] === 3 &&  db.get()[2] === 4;
				})(), true, 'count -> 2, from -> 1, rev -> true');
				
				equal($C([1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, function (el) {
					return el > 2;
				}).get()[0], 1, 'filter -> "function (el) { return el > 2; }"');
				equal($C([1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, ':el > 2').get()[0], 1, 'filter -> ":el > 2"');
				
				equal($C([1, 2, 3, 4]).forEach(function (el, key, data) {
					data[key] += 1;
				}, '(:el > 2) && (:el < 4)').get()[3], 4, 'filter -> "(:el > 2) && (:el < 4)"');
				
				equal((function () {
					var db = $C([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
						.forEach(':data[key] += 2', ':el % 2 === 0', '', '', 2, 1, 2, 6, true)
						.get();
					
					return db[11] === 12 && db[7] === 10 && db[5] === 6;
				})(), true, 'filter -> ":el % 2 === 0", count -> 2, from -> 1, indexOf -> 2, lastIndexOf -> 6, rev -> true');
				
				equal((function () {
					var cLength, fLength;
					
					$C([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12])
						.forEach(function (el, key, data, i, length) {
							cLength = length();
							data[key] += 2;
						}, function (el, key, data, i, length) {
							fLength = length();
							
							return el % 2 === 0;
						}, '', '', 2, 1, 2, 6, true);
						
					return cLength === 6 && fLength === 12;
				})(), true, 'call the internal functions');
			});
			
			test('forEach (with object)', function () {
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}).get()[0], 2, 'simple forEach');
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(':data[key] += 1').get()[0], 2, 'simple forEach with string expression');
				
				equal($C().pushCollection('test', {0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', 'test').getCollection('test')[0], 2, 'id -> test');
				
				equal($C().pushSetCollection('test', {0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', 'active').getCollection('test')[0], 2, 'id -> active');
				
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, '', '', false).get()[1], 2, 'mult -> false');
				
				equal((function () {
					var db = $C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2);
					
					return db.get()[1] === 3 &&  db.get()[2] === 3;
				})(), true, 'count -> 2');
				
				equal((function () {
					var db = $C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2, 1).get();
					
					return db[1] === 3 && db[2] === 4;
				})(), true, 'count -> 2, from -> 1');
				
				equal((function () {
					var db = $C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
						data[key] += 1;
					}, '', '', '', 2, 1, '', true);
					
					return db.get()[1] === 3 &&  db.get()[2] === 4;
				})(), true, 'count -> 2, from -> 1, rev -> true');
				
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, function (el) {
					return el > 2;
				}).get()[0], 1, 'filter -> "function (el) { return el > 2; }"');
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, ':el > 2').get()[0], 1, 'filter -> ":el > 2"');
				
				equal($C({0: 1, 1: 2, 2: 3, 3: 4}).forEach(function (el, key, data) {
					data[key] += 1;
				}, '(:el > 2) && (:el < 4)').get()[3], 4, 'filter -> "(:el > 2) && (:el < 4)"');
				
				equal((function () {
					var db = $C({0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7, 7: 8, 8: 9, 9: 10, 10: 11, 11: 12})
						.forEach(':data[key] += 2', ':el % 2 === 0', '', '', 2, 1, 2, 6, true)
						.get();
					
					return db[11] === 12 && db[7] === 10 && db[5] === 6;
				})(), true, 'filter -> ":el % 2 === 0", count -> 2, from -> 1, indexOf -> 2, lastIndexOf -> 6, rev -> true');
				
				equal((function () {
					var cLength, fLength;
					
					$C({0: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6, 6: 7, 7: 8, 8: 9, 9: 10, 10: 11, 11: 12})
						.forEach(function (el, key, data, i, length) {
							cLength = length();
							data[key] += 2;
						}, function (el, key, data, i, length) {
							fLength = length();
							
							return el % 2 === 0;
						}, '', '', 2, 1, 2, 6, true);
					
					return cLength === 6 && fLength === 12;
				})(), true, 'call the internal functions');
			});
			
			test('length', function () {
				var db = new Collection({first: [[1, 2, {second: 3}], 2, 3], last: 2});
				db.pushCollection({table1: null, table2: 'GO!'});
				
				equal(db.length([1, 2, 3]), 3, 'array');
				equal(db.length(function (el, key, data) {
					return el === 1;
				}, [1, 2, 3]), 1, 'array with filter');
				
				equal(db.length(true, 'table1'), 0, 'null');
				equal(db.length(true, 'table2'), 3, 'string');
				equal(db.length(), 2, 'object');
				equal(db.length(function (el, key, data) {
					return key === 'first';
				}), 1, 'object with filter');
				
				db.pushFilter({
					a: function (el, key, data) {
						return el === 1;
					},
					b: function (el, key, data) {
						return el === 2;
					}
				});
				
				equal(db.length('a || b', [1, 2, 3]), 2, 'array with filter -> "a || b"');
				equal(db.length('a && b', [1, 2, 3]), 0, 'array with filter -> "a && b"');
				equal(db.length('(a && b) || a', [1, 2, 3]), 1, 'array with filter -> "(a && b) || a"');
				equal(db.length('a && !b', [1, 2, 3]), 2, 'array with filter -> "a && !b"');
				equal(db.length('!(a && b)', [1, 2, 3]), 3, 'array with filter -> "!(a && b)"');
				equal(db.length('! (a && b) && a', [1, 2, 3]), 1, 'array with filter -> "! (! a && b) && a"');
				
				equal(db.length('a || b', {0: 1, 1: 2, 2: 3}), 2, 'object with filter -> "a || b"');
				equal(db.length('a && b', {0: 1, 1: 2, 2: 3}), 0, 'object with filter -> "a && b"');
				equal(db.length('(a && b) || a', {0: 1, 1: 2, 2: 3}), 1, 'object with filter -> "(a && b) || a"');
				equal(db.length('a && !b', {0: 1, 1: 2, 2: 3}), 2, 'object with filter -> "a && !b"');
				equal(db.length('!(a && b)', {0: 1, 1: 2, 2: 3}), 3, 'object with filter -> "!(a && b)"');
				equal(db.length('! (a && b) && a', {0: 1, 1: 2, 2: 3}), 1, 'object with filter -> "! (! a && b) && a"');
			});
			
			
			module('search methods');
			test('search', function () {
				var db = new Collection([1, 2, 3, 4, 1, 2, 3, 4]);
				
				equal(db.search(function (el, key, data) {
					return el === 1;
				})[0], 0, 'simple search');
				equal(db.indexOf(1), 0, 'indexOf');
				equal(db.indexOf(1, 2), 4, 'indexOf with fromIndex');
				
				equal(db.lastIndexOf(1), 4, 'lastIndexOf');
			});
			
			/*test('get', function () {
				var db = new Collection([1, 2, 3, 4]);
				
				equal(db.get(function (el, key, data) {
					return el === 1;
				})[0], 1, 'simple return');
			});
			test('set', function () {
				equal($C([1, 2, 3, 4]).set(true, 2).get()[0], 2, 'simple replace');
				equal($C([1, 2, 3, 4]).set(true, '+=2').get()[0], 3, 'simple replace: += 2');
				equal($C([{a: 1}, {a: 2}, {a: 3}, {a: 4}]).set(true, ':el.a += 1').get()[0].a, 2, 'replace with string expression (without return)');
				equal($C([{a: 1}, {a: 2}, {a: 3}, {a: 4}]).set(true, ':return 22').get()[0], 22, 'replace with string expression');
				
				equal($C([1, 2, 3, 4]).map(Math.sin).get()[0].toFixed(2), '0.84', 'map');
			});
			test('remove', function () {
				var db = new Collection([1, 2, 3, 4]);
				
				equal(db.remove(function (el, key, data) {
					return el === 1;
				}).get('0'), 2, 'simple remove');
			});
			test('move', function () {
				var db = new Collection([1, 2, 3, 4]).pushCollection('table1', [1, 2, []]);
				equal(db.newContext('eq(-1)').move(true, '', 'active', 'table1').getCollection().length, 0, 'simple move');
				equal(db.resetContext().move('eq(-1)', '', 'table1').getCollection()[0].length, 4, 'move by link');
			});
			test('group', function () {
				var db = new Collection([
					{name: 'Koba', age: 22, lvl: 78},
					{name: 'Over', age: 27, lvl: 85},
					{name: 'Drobila', age: 27, lvl: 80},
					{name: 'Skins', age: 28, lvl: 79}
				]);
				
				equal(db.group('age')[27].length, 2, 'group by parameter');
				equal(db.group(':el.age < 28')[true].length, 3, 'group by expression');
				equal(db.group(function (el, i) { return i % 2 === 0; })[true].length, 2, 'group by function');
			});*/
		});
	</script>
</head>

<body>
	<h1 id="qunit-header">Collection: mult test</h1>
	<h2 id="qunit-banner"></h2>
	<div id="qunit-testrunner-toolbar"></div>
	<h2 id="qunit-userAgent"></h2>
	<ol id="qunit-tests"></ol>
</body>
</html>
