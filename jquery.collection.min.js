/**
 * $.Collection
 * 
 * autor: kobezzza (kobezzza@gmail.com | http://kobezzza.com)
 * version: 3.3.5
 * date: 08.01.2012 14:23:06
 */
 var nimble={name:"nimble",version:"1.0.2",nimble:function(){return this.name+" "+this.version},CONTEXT_SEPARATOR:" ",QUERY_SEPARATOR:"/",SUBQUERY_SEPARATOR:"{",METHOD_SEPARATOR:"->",CHILDREN:">",ORDER:["eq(",")"],trim:function(d){d=d.replace(/^\s\s*/,"");for(var a=/\s/,b=d.length;a.test(d.charAt(b-=1)););return d.substring(0,b+1)},isString:function(d){return Object.prototype.toString.call(d)==="[object String]"},isNumber:function(d){return Object.prototype.toString.call(d)==="[object Number]"},isArray:function(d){return Object.prototype.toString.call(d)===
"[object Array]"},isExist:function(d){return d!==undefined&&d!=="undefined"&&d!==null&&d!==""},expr:function(d,a){a=a!==undefined||a!==null?a:"";if(this.isString(d)&&d.search(/^[+-\\*/]{1}=/)!==-1){d=d.split("=");isNaN(d[1])||(d[1]=+d[1]);switch(d[0]){case "+":d=a+d[1];break;case "-":d=a-d[1];break;case "*":d=a*d[1];break;case "/":d=a/d[1]}}return d},byLink:function(d,a,b,c){a=a.toString().replace(RegExp("\\s*"+this.CHILDREN+"\\s*","g")," "+this.CHILDREN+" ").split(this.CONTEXT_SEPARATOR);c=c||false;
for(var e=this.CHILDREN,g=0,f=0,h,j=a.length,k,l;(j-=1)>-1;){a[j]=this.trim(a[j]);if(a[j]===""){a.splice(j,1);g-=1}else if(a[j]!==this.CHILDREN){if(j>g)g=j;f+=1}}l=a.length;if(d===false)return a.join("");else if(this.isNumber(d)){if((d=+d)<0)d+=f;if(b===undefined){j=-1;for(k=0;(j+=1)<l;)if(a[j]!==this.CHILDREN)if((k+=1)===d){a.splice(j+1,l);return a.join("")}}else{j=l;for(k=0;(j-=1)>-1;)if(a[j]!==this.CHILDREN)if((k+=1)===d){a.splice(0,j);return a.join("")}}}for(j=-1;(j+=1)<l;)switch(a[j]){case this.CHILDREN:e=
a[j];break;default:if(e===this.CHILDREN&&a[j].substring(0,this.ORDER[0].length)!==this.ORDER[0])if(j===g&&b!==undefined)if(c===false)d[a[j]]=this.expr(b,d[a[j]]);else if(nimble.isArray(d))d.splice(a[j],1);else delete d[a[j]];else d=d[a[j]];else{f=a[j].substring(this.ORDER[0].length);f=f.substring(0,f.length-1);f=+f;if(this.isArray(d))if(j===g&&b!==undefined)if(f>=0)if(c===false)d[f]=this.expr(b,d[f]);else d.splice(f,1);else if(c===false)d[d.length+f]=this.expr(b,d[d.length+f]);else d.splice(d.length+
f,1);else d=f>=0?d[f]:d[d.length+f];else{if(f<0){k=0;for(h in d)if(d.hasOwnProperty(h))k+=1;f+=k}k=0;for(h in d)if(d.hasOwnProperty(h)){if(f===k){if(j===g&&b!==undefined)if(c===false)d[h]=this.expr(b,d[h]);else delete d[h];else d=d[h];break}k+=1}}}}if(b!==undefined)return this;return d},execEvent:function(d,a,b,c){d=d.split(this.QUERY_SEPARATOR);b=this.isExist(b)?b:[];b=this.isArray(b)?b:[b];for(var e=-1,g=d.length-1;(e+=1)<g;)a=a[d[e]];if(d[e].search(this.SUBQUERY_SEPARATOR)!==-1){d=d[e].split(this.SUBQUERY_SEPARATOR);
a=a[d[0]];d.splice(0,1);b=b.concat(d);return a.apply(c||a,b)}else return a[d[e]].apply(c||a,b)},addElementToObject:function(d,a,b){a=a.split(this.METHOD_SEPARATOR);var c,e={};if(a[1]&&a[1]=="unshift"){e[!isNaN(Number(a[0]))?0:a[0]]=b;for(c in d)if(d.hasOwnProperty(c))e[!isNaN(Number(c))?+c+1:c]=d[c];return e}else if(!a[1]||a[1]=="push")d[a[0]]=b;return true}};
(function(d){d.Collection=function(a,b){a=a||null;b=b||null;if(this.fn&&(!this.fn.name||this.fn.name!=="$.Collection"))return new d.Collection(a,b);d.extend(true,this,d.Collection.storage);var c=this.dObj.active;b&&d.extend(true,c,b);if(d.isString(a)){c.target=d(a);c.collection=null}else c.collection=a};d.Collection.prototype={name:"$.Collection",version:"3.4",collection:function(){return this.name+" "+this.version},ACTIVE:"active",SHUFFLE:"shuffle",stack:["collection","filter","context","cache",
"variable","defer","page","parser","appendType","target","calculator","pager","template","numberBreak","pageBreak","resultNull"]};d.fn.collection=function(a){var b=d.fn.collection.stat,c=function(f){f=f.childNodes;for(var h=f.length,j=-1,k="";(j+=1)<h;)if(f[j].nodeType===3&&d.trim(f[j].textContent))k+=f[j].textContent;if(k)return k;return false},e=function(f){var h=[];f.each(function(j){var k=d(this),l=k.data(),m=k.attr("class")?k.attr("class").split(" "):"",n=c(this),o;h.push({});for(o in l)if(l.hasOwnProperty(o))h[j][o]=
l[o];if(m){h[j][b.classes]={};m.forEach(function(q){h[j][b.classes][q]=q})}if(k.children().length!==0)h[j][b.childNodes]=e(k.children());if(n!==false)h[j][b.val]=n.replace(/[\r\t\n]/g," ")});return h},g=e(this);if(a)return new d.Collection(g,a);return new d.Collection(g)};if(!d.fn.collection.stat)d.fn.collection.stat={val:"val",childNodes:"childNodes",classes:"classes"};d.fn.ctplCompile=function(){if(this.length===0)throw Error("DOM element isn't exist!");var a="var key = i, result = ''; ";this.html().replace(/\/\*.*?\*\//g,
"").split("?>").join("<?js").replace(/[\r\t\n]/g," ").split("<?js").forEach(function(b,c){a+=c===0||c%2===0?"result +='"+b+"';":b.split("echo").join("result +=")});return new Function("el","i","data","cOLength","cObj","id",a+" return result;")};d.fn.ctplMake=function(a){this.find("[type='text/ctpl']").each(function(){var b=d(this),c=b.data(),e=c.prefix?c.prefix+"_":"";a.pushTemplate(e+c.name,b.ctplCompile());c.set&&c.set===true&&a.setTemplate(e+c.name)})};d.isString=function(a){return nimble.isString(a)};
d.isBoolean=function(a){return Object.prototype.toString.call(a)==="[object Boolean]"};d.isExist=function(a){return nimble.isExist(a)};d.unshiftArguments=function(a,b){for(var c=[b],e=-1,g=a.length;(e+=1)<g;)c.push(a[e]);return c};d.toUpperCase=function(a,b,c){c=c||0;b=d.isExist(b)?c+b:a.length;return a.substring(0,c)+a.substring(c,b).toUpperCase()+a.substring(b)};d.toLowerCase=function(a,b,c){c=c||0;b=d.isExist(b)?c+b:a.length;return a.substring(0,c)+a.substring(c,b).toLowerCase()+a.substring(b)};
d.Collection.storage={dObj:{active:{collection:null,filter:false,context:"",cache:{autoIteration:false,iteration:false,firstIteration:false,lastIteration:false},variable:null,defer:"",page:1,parser:false,appendType:"html",target:null,calculator:".line",pager:"#pageControl",template:null,numberBreak:10,pageBreak:10,resultNull:""}}};d.Collection.storage.dObj.sys={flags:{use:{context:true,filter:true,parser:true}}};(function(a){var b,c=d.Collection.storage.dObj.sys;a.forEach(function(e){b=d.toUpperCase(e,
1);c["active"+b+"ID"]=null;c["tmp"+b]={};c[e+"ChangeControl"]=null;c[e+"Back"]=[]})})(d.Collection.prototype.stack);d.Collection.prototype._new=function(a,b){var c=this.dObj.active,e=d.toUpperCase(a,1);c[a]=a==="filter"&&d.isString(b)?this._compileFilter(b):nimble.expr(b,c[a]||"");this.dObj.sys["active"+e+"ID"]=null;return this};d.Collection.prototype._update=function(a,b){var c=this.dObj.active,e=this.dObj.sys,g=d.toUpperCase(a,1),f=e["active"+g+"ID"];c[a]=a==="filter"&&d.isString(b)?this._compileFilter(b):
nimble.expr(b,c[a]||"");if(f)e["tmp"+g][f]=c[a];return this};d.Collection.prototype._get=function(a,b){if(b&&b!==this.ACTIVE){if(!this._exist(a,b))throw Error('the object "'+b+'" -> "'+a+"\" isn't exist in the stack!");return this.dObj.sys["tmp"+d.toUpperCase(a,1)][b]}return this.dObj.active[a]};d.Collection.prototype._push=function(a,b,c){var e=this.dObj.sys,g=d.toUpperCase(a,1),f=e["tmp"+g];e=e["active"+g+"ID"];var h;if(d.isPlainObject(b))for(h in b){if(b.hasOwnProperty(h))if(h===this.ACTIVE)throw Error("invalid property name!");
else if(f[h]&&e&&e===h)this._update(a,b[h]);else f[h]=a==="filter"&&d.isString(b[h])?this._compileFilter(b[h]):b[h]}else if(b===this.ACTIVE)throw Error("invalid property name!");else if(f[b]&&e&&e===b)this._update(a,c);else f[b]=a==="filter"&&d.isString(c)?this._compileFilter(c):c;return this};d.Collection.prototype._set=function(a,b){var c=this.dObj.sys,e=d.toUpperCase(a,1),g=a+"ChangeControl",f="active"+e+"ID";if(!this._exist(a,b))throw Error('the object "'+b+'" -> "'+a+"\" isn't exist in the stack!");
if(c[f]!==b){c[g]=true;c[f]=b}else c[g]=false;c[a+"Back"].push(b);this.dObj.active[a]=c["tmp"+e][b];return this};d.Collection.prototype._back=function(a,b){var c=this.dObj.sys,e=d.toUpperCase(a,1),g=c[a+"Back"],f;f=g.length-(b||1)-1;if(f>=0&&g[f])if(c["tmp"+e][g[f]]){this._set(a,g[f]);c[a+"ChangeControl"]=false;g.splice(f+1,g.length)}return this};d.Collection.prototype._backIf=function(a){if(this.dObj.sys[a+"ChangeControl"]===true)return this._back.apply(this,arguments);return this};d.Collection.prototype._drop=
function(a,b,c,e){c=c===undefined?false:c;var g=this.dObj.active,f=this.dObj.sys,h=d.toUpperCase(a,1),j="active"+h+"ID";h="tmp"+h;var k=f[j];b=!b?k?[k]:[]:d.isArray(b)||d.isPlainObject(b)?b:[b];var l;if(b[0]&&b[0]!==this.ACTIVE)for(l in b){if(b.hasOwnProperty(l))if(!b[l]||b[l]===this.ACTIVE)if(e===undefined){k&&delete f[h][k];f[j]=null;g[a]=c}else{if(k)f[h][k]=e;g[a]=e}else if(e===undefined){delete f[h][b[l]];if(k&&b[l]===k){f[j]=null;g[a]=c}}else{f[h][b[l]]=e;if(k&&b[l]===k)g[a]=e}}else if(e===undefined){k&&
delete f[h][k];f[j]=null;g[a]=c}else{if(k)f[h][k]=e;g[a]=e}return this};d.Collection.prototype._reset=function(a,b,c){return this._drop(a,b||"","",c===undefined?false:c)};d.Collection.prototype._resetTo=function(a,b,c){c=!c||c===this.ACTIVE?this.dObj.active[a]:this.dObj.sys["tmp"+d.toUpperCase(a,1)][c];return this._reset(a,b||"",c)};d.Collection.prototype._exist=function(a,b){var c=d.toUpperCase(a,1);if((!b||b===this.ACTIVE)&&this.dObj.sys["active"+c+"ID"])return true;if(this.dObj.sys["tmp"+c][b]!==
undefined)return true;return false};d.Collection.prototype._isActive=function(a,b){if(b===this.dObj.sys["active"+d.toUpperCase(a,1)+"ID"])return true;return false};d.Collection.prototype.use=function(a){for(var b=this.stack.length;(b-=1)>-1;)this._exist(this.stack[b],a)&&this._set(this.stack[b],a);return this};d.Collection.prototype._prop=function(a,b,c){var e=this.dObj[a];if(arguments.length!==3)if(d.isPlainObject(b))d.extend(e,b);else return e[b];else e[b]=c;return this};d.Collection.prototype.active=
function(){return this._prop.apply(this,d.unshiftArguments(arguments,"active"))};(function(a){var b=d.Collection.prototype,c;a.forEach(function(e){c=d.toUpperCase(e,1);b["new"+c]=function(g){return function(f){return this._new(g,f)}}(e);b["update"+c]=function(g){return function(f){return this._update(g,f)}}(e);b["reset"+c+"To"]=function(g){return function(f,h){return this._resetTo(g,f,h)}}(e);b["push"+c]=function(g){return function(){return this._push.apply(this,d.unshiftArguments(arguments,g))}}(e);
b["set"+c]=function(g){return function(f){return this._set(g,f)}}(e);b["pushSet"+c]=function(g){return function(f,h){return this._push(g,f,h)._set(g,f)}}(e);b["back"+c]=function(g){return function(f){return this._back(g,f||"")}}(e);b["back"+c+"If"]=function(g){return function(f){return this._backIf(g,f||"")}}(e);b["drop"+c]=e==="filter"||e==="parser"?function(g){return function(){return this._drop(g,arguments)}}(e):function(g){return function(){return this._drop(g,arguments,null)}}(e);if(e==="filter"||
e==="parser")b["reset"+c]=function(g){return function(){return this._reset(g,arguments)}}(e);else if(e==="page")b["reset"+c]=function(g){return function(){return this._reset(g,arguments,1)}}(e);else if(e==="context")b["reset"+c]=function(g){return function(){return this._reset(g,arguments,"")}}(e);b["isActive"+c]=function(g){return function(f){return this._isActive(g,f)}}(e);b["exist"+c]=function(g){return function(f){return this._exist(g,f||"")}}(e);b["get"+c]=function(g){return function(f){return this._get(g,
f||"")}}(e)})})(d.Collection.prototype.stack);d.Collection.prototype._setOne=function(a,b,c){a=d.isExist(a)?a.toString():"";b=b===undefined?"":b;c=c||"";var e=this._getActiveParam("context");if(!a&&!e)return c&&c!==this.ACTIVE?this._push("collection",c,b):this._update("collection",b);nimble.byLink(this._get("collection",c),e+nimble.CHILDREN+a,b);return this};d.Collection.prototype._getOne=function(a,b){a=d.isExist(a)?a.toString():"";return nimble.byLink(this._get("collection",b||""),this._getActiveParam("context")+
nimble.CHILDREN+a)};d.Collection.prototype.add=function(a,b,c,e,g){a=a!==undefined?a:"";b=b||"push";c=c||"";g=g||false;var f,h,j;f=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(typeof f==="object"){if(e){a=d.isExist(a)?a.toString():"";h=nimble.byLink(this._get("collection",e||""),a);if(d.isPlainObject(f)){b=b==="push"?this.length(f):b==="unshift"?this.length(f)+nimble.METHOD_SEPARATOR+"unshift":b;j=nimble.addElementToObject(f,b.toString(),h)}else{j=true;f[b](h)}g===true&&
this.disable("context")._removeOne(a,e).enable("context")}else if(d.isPlainObject(f)){b=b==="push"?this.length(f):b==="unshift"?this.length(f)+nimble.METHOD_SEPARATOR+"unshift":b;j=nimble.addElementToObject(f,b.toString(),a)}else{j=true;f[b](a)}j!==true&&this._setOne("",j,c)}else throw Error("unable to set property!");return this};d.Collection.prototype.push=function(a,b){return this.add(a,"",b||"")};d.Collection.prototype.unshift=function(a,b){return this.add(a,"unshift",b||"")};d.Collection.prototype._removeOne=
function(a,b){a=d.isExist(a)?a.toString():"";var c=this._getActiveParam("context");!a&&!c?this._setOne("",null):nimble.byLink(this._get("collection",b||""),c+nimble.CHILDREN+a,"",true);return this};d.Collection.prototype._remove=function(a,b){b=b||"";var c,e;if(d.isPlainObject(a))for(c in a){if(a.hasOwnProperty(c))if(d.isArray(a[c]))for(e=a[c].length;(e-=1)>-1;)this._removeOne(a[c][e],c);else this._removeOne(a[c],c)}else if(d.isArray(a))for(e=a.length;(e-=1)>-1;)this._removeOne(a[e],b);else this._removeOne(a,
b);return this};d.Collection.prototype.pop=function(a){return this._removeOne("eq(-1)",a||"")};d.Collection.prototype.shift=function(a){return this._removeOne("eq(0)",a||"")};d.Collection.prototype.concat=function(a,b,c){b=d.isExist(b)?b.toString():"";c=c||"";var e=nimble.byLink(this._get("collection",c),this._getActiveParam("context")+nimble.CHILDREN+b);if(typeof e==="object")if(d.isPlainObject(e))d.extend(true,e,a);else{if(d.isArray(e))if(d.isArray(a)){e=Array.prototype.concat(e,a);this._setOne(b,
e,c)}else this.add(a,"push",c)}else throw Error("incorrect data type!");return this};d.Collection.prototype.length=function(a,b){a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");var c,e,g,f;if(!d.isFunction(a))if(d.isString(a)&&!d.isExist(b)||d.isArray(a)||d.isPlainObject(a)){b=a;a=false}if(!b||b===this.ACTIVE)c=this._get("collection");else if(d.isString(b))c=this._get("collection",b);else{e=true;c=b}if(c===null)return 0;if(e!==true)c=nimble.byLink(c,this._getActiveParam("context"));if(d.isString(c))return c.length;
if(typeof c==="object")if(a===false&&c.length!==undefined)f=c.length;else{f=0;if(c.length!==undefined)c.forEach(function(h,j){if(this._customFilter(a,h,j,c,f||null,this,b?b:this.ACTIVE)===true)f+=1},this);else for(g in c)if(c.hasOwnProperty(g))if(this._customFilter(a,c[g],g,c,f||null,this,b?b:this.ACTIVE)===true)f+=1}else throw Error("incorrect data type!");return f};d.Collection.prototype.forEach=function(a,b,c,e,g,f,h){a=d.isFunction(a)?{filter:a}:a;b=d.isExist(b)&&b!==true?b:this._getActiveParam("filter");
c=d.isExist(c)?c:this.ACTIVE;if(d.isBoolean(c)){h=f;f=g;g=e;e=c;c=this.ACTIVE}e=e===false?false:true;g=parseInt(g)>=0?parseInt(g):false;f=parseInt(f)||false;h=parseInt(h)||false;var j,k,l,m=0,n=false,o;j=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(typeof j!=="object")throw Error("incorrect data type!");k=this.length(j);if(d.isArray(j)){l=h!==false?j.slice(h):j;l.some(function(q,p){p+=h;if(g!==false&&m===g)return true;if(this._customFilter(b,q,p,j,k,this,c)===true)if(f!==
false&&f!==0)f-=1;else{if(a.filter)n=a.filter.call(a.filter,q,p,j,k,this,c)===false;if(e===false)n=true;m+=1}else if(a.denial&&(f===false||f===0)){o=a.denial.call(a.denial,q,p,j,k,this,c);if(n===false&&o===false)n=true}if(a.full&&(f===false||f===0)){o=a.full.call(a.full,q,p,j,k,this,c);if(n===false&&o===false)n=true}if(n===true)return true;o=""},this)}else for(l in j){if(j.hasOwnProperty(l)){if(g!==false&&m===g)break;if(h!==false&&h!==0){h-=1;continue}if(this._customFilter(b,j[l],l,j,k,this,c)===
true)if(f!==false&&f!==0)f-=1;else{if(a.filter)n=a.filter.call(a.filter,j[l],l,j,k,this,c)===false;if(e===false)n=true;m+=1}}else if(a.denial&&(f===false||f===0)){o=a.denial.call(a.denial,j[l],l,j,k,this,c);if(n===false&&o===false)n=true}if(a.full&&(f===false||f===0)){o=a.full.call(a.full,j[l],l,j,k,this,c);if(n===false&&o===false)n=true}if(n===true)break;o=""}return this};if(!Array.prototype.forEach)Array.prototype.forEach=function(a,b){for(var c=-1,e=this.length;(c+=1)<e;)b?a.call(b,this[c],c,this):
a(this[c],c,this)};if(!Array.prototype.some)Array.prototype.some=function(a,b){for(var c=-1,e=this.length,g;(c+=1)<e;){g=b?a.call(b,this[c],c,this):a(this[c],c,this);if(g===true)break}};d.Collection.prototype.search=function(a,b,c,e,g,f){a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");b=d.isExist(b)?b:this.ACTIVE;if(d.isBoolean(b)){f=g;g=e;e=c;c=b;b=this.ACTIVE}c=c===false?false:true;e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;f=parseInt(f)||false;var h=c===true?[]:-1;this.forEach(function(j,
k){if(c===true)h.push(k);else h=k;return true},a,b,c,e,g,f);return h};d.Collection.prototype.searchOne=function(a,b){return this.search(d.isExist(a)?a:"",b||"",false)};d.Collection.prototype.indexOf=function(a,b,c){c=c||"";b=b||"";var e=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(d.isArray(e)&&e.indexOf){if(b)return e.indexOf(a,b);return e.indexOf(a)}else return this.search(function(g){return g===a},c,false,"","",b)};d.Collection.prototype.lastIndexOf=function(a,b,
c){c=c||"";b=b||"";var e=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(d.isArray(e)&&e.lastIndexOf){if(b)return e.lastIndexOf(a,b);return e.lastIndexOf(a)}else{b=this.search(function(g){return g===a},c,"","","",b);return b[b.length-1]!==undefined?b[b.length-1]:-1}};d.Collection.prototype.get=function(a,b,c,e,g,f){if(d.isNumeric(a)||arguments.length<2&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<2&&a===null)return this._getOne(a,b||"");
a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");b=d.isExist(b)?b:this.ACTIVE;if(d.isBoolean(b)){f=g;g=e;e=c;c=b;b=this.ACTIVE}c=c===false?false:true;e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;f=parseInt(f)||false;var h=c===true?[]:-1;this.forEach(function(j,k,l){if(c===true)h.push(l[k]);else h=l[k];return true},a,b,c,e,g,f);return h};d.Collection.prototype.getOne=function(a,b){return this.get(d.isExist(a)?a:"",b||"",false)};d.Collection.prototype.set=function(a,b,c,e,g,f,h){if(d.isNumeric(a)||
arguments.length<3&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<3&&a===null)return this._setOne(a,b,c||"");a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");c=d.isExist(c)?c:this.ACTIVE;if(d.isBoolean(c)){h=f;f=g;g=e;e=c;c=this.ACTIVE}e=e===false?false:true;g=parseInt(g)>=0?parseInt(g):false;f=parseInt(f)||false;h=parseInt(h)||false;var j=d.isFunction(b);this.forEach(function(k,l,m,n,o,q){m[l]=j?b.call(b,k,l,m,n,o,q):nimble.expr(b,m[l]);return true},a,c,e,g,
f,h);return this};d.Collection.prototype.setOne=function(a,b,c){return this.set(d.isExist(a)?a:"",b,c||"",false)};d.Collection.prototype.map=function(a,b){return this.set(true,a,b||"")};d.Collection.prototype.some=function(a,b,c){return this.forEach(a,b||"",c||"",false)};d.Collection.prototype.move=function(a,b,c,e,g,f,h,j,k,l){a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");l=l===false?false:true;b=d.isExist(b)?b.toString():"";c=c||"";e=e||"";g=g||"push";f=f===false?false:true;h=parseInt(h)>=
0?parseInt(h):false;j=parseInt(j)||false;k=parseInt(k)||false;var m=[],n=d.isArray(nimble.byLink(this._get("collection",e),this._getActiveParam("context")));this.disable("context");a=this.search(a,c,f,h,j,k);this.enable("context");if(f===true)a.forEach(function(o){this.add(b+nimble.CHILDREN+o,n===true?g:o+nimble.METHOD_SEPARATOR+g,e,c);l===true&&m.push(o)},this);else{this.add(b+nimble.CHILDREN+a,n===true?g:a+nimble.METHOD_SEPARATOR+g,e,c);l===true&&m.push(a)}l===true&&this.disable("context")._remove(m,
c).enable("context");return this};d.Collection.prototype.moveOne=function(a,b,c,e,g){return this.move(d.isExist(a)?a:"",d.isExist(b)?b.toString():"",c||"",e||"",g||"",false)};d.Collection.prototype.copy=function(a,b,c,e,g,f,h,j,k){f=f===false?false:true;h=parseInt(h)>=0?parseInt(h):false;j=parseInt(j)||false;k=parseInt(k)||false;return this.move(d.isExist(a)?a:"",d.isExist(b)?b.toString():"",c||"",e||"",g||"push",f,h,j,k,false)};d.Collection.prototype.copyOne=function(a,b,c,e,g){return this.move(d.isExist(a)?
a:"",d.isExist(b)?b.toString():"",c||"",e||"",g||"",false,"","","",false)};d.Collection.prototype.remove=function(a,b,c,e,g,f){if(d.isNumeric(a)||arguments.length<2&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<2&&a===null)return this._removeOne(a,b||"");else if(d.isArray(a)||d.isPlainObject(a))return this._remove(a,b||"");a=d.isExist(a)&&a!==true?a:this._getActiveParam("filter");b=d.isExist(b)?b:this.ACTIVE;if(d.isBoolean(b)){f=g;g=e;e=c;c=b;b=this.ACTIVE}c=c===false?
false:true;e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;f=parseInt(f)||false;var h=this.search(a,b,c,e,g,f),j;if(c===false)this._removeOne(h,b);else for(j=h.length;(j-=1)>-1;)this._removeOne(h[j],b);return this};d.Collection.prototype.removeOne=function(a,b){return this.remove(d.isExist(a)?a:"",b||"",false)};d.Collection.prototype.sort=function(a,b,c,e){a=a||null;b=b||false;c=c&&c!==true?c===false?null:c:function(l){if(isNaN(l))return l.toUpperCase();return l};e=e||"";var g=this,f,h=function(l,
m){var n=b?-1:1;if(a){l=nimble.byLink(l,a);m=nimble.byLink(m,a)}if(c){l=c(l);m=c(m)}if(b!==g.SHUFFLE){if(l<m)return n*-1;if(l>m)return n;return 0}else return Math.round(Math.random()*2-1)},j=function(l){var m=[],n={},o;for(o in l)l.hasOwnProperty(o)&&m.push(o);m.sort(h);for(o in m)if(m.hasOwnProperty(o))n[m[o]]=l[m[o]];return n},k=function(l){var m=[],n={},o;for(o in l)l.hasOwnProperty(o)&&m.push({key:o,value:l[o]});a=a===true?"value":"value"+nimble.CHILDREN+a;m.sort(h);for(o in m)if(m.hasOwnProperty(o))n[m[o].key]=
m[o].value;return n};f=nimble.byLink(this._get("collection",e),this._getActiveParam("context"));if(typeof f==="object")if(d.isArray(f))f.sort(h);else{f=a?k(f):j(f);this._setOne("",f,e)}else throw Error("incorrect data type!");return this};d.Collection.prototype.reverse=function(a){a=a||"";var b,c=function(e){var g=[],f={},h;for(h in e)e.hasOwnProperty(h)&&g.push(h);g.reverse();for(h in g)if(g.hasOwnProperty(h))f[g[h]]=e[g[h]];return f};b=nimble.byLink(this._get("collection",a),this._getActiveParam("context"));
if(typeof b==="object")d.isArray(b)?b.reverse():this._setOne("",c(b),a);else throw Error("incorrect data type!");return this};d.Collection.prototype.save=function(a,b){if(!localStorage)throw Error("your browser does't support web storage!");a=a||this.ACTIVE;(b===false?b:true)===false?sessionStorage.setItem("__"+this.name+":"+a,this.toString(a)):localStorage.setItem("__"+this.name+":"+a,this.toString(a));return this};d.Collection.prototype.load=function(a,b){if(!localStorage)throw Error("your browser does't support web storage!");
a=a||this.ACTIVE;if((b===false?b:true)===false)a===this.ACTIVE?this._new("collection",sessionStorage.getItem("__"+this.name+":"+a)):this._push("collection",a,d.parseJSON(sessionStorage.getItem("__"+this.name+":"+a)));else a===this.ACTIVE?this._new("collection",d.parseJSON(localStorage.getItem("__"+this.name+":"+a))):this._push("collection",a,d.parseJSON(localStorage.getItem("__"+this.name+":"+a)));return this};d.Collection.prototype.drop=function(a,b){if(!localStorage)throw Error("your browser does't support web storage!");
a=a||this.ACTIVE;(b===false?b:true)===false?sessionStorage.removeItem("__"+this.name+":"+a):localStorage.removeItem("__"+this.name+":"+a);return this};d.Collection.prototype._customFilter=function(a,b,c,e,g,f,h){var j,k,l,m=true,n,o,q,p;if(a===false)return true;if(d.isFunction(a))return a.call(a,b,c,e,g,f,h);if(!a||d.isString(a)&&d.trim(a)===this.ACTIVE){if(this._get("filter")){if(d.isFunction(this._get("filter")))return this._get("filter").call(this._get("filter"),b,c,e,g,f,h);return this._customFilter(this._get("filter"),
b,c,e,g,f,h)}return true}else{if(!d.isArray(a)){if(a.search(/\|\||&&|!/)===-1){a=d.trim(a);if(a.search(/^(?:\(|)*:/)!==-1){l=this._compileFilter(a);return l.call(l,b,c,e,g,f,h)}return this._customFilter(this._get("filter",a),b,c,e,g,f,h)}a=d.trim(a.toString().replace(/\s*(\(|\))\s*/g," $1 ").replace(/\s*(\|\||&&)\s*/g," $1 ").replace(/(!)\s*/g,"$1")).split(" ");for(c=a.length;(c-=1)>-1;)a[c]===""&&a.splice(c,1)}k=function(r,u){for(var s=-1,w=r.length,t=0,v=[];(s+=1)<w;){u+=1;if(r[s]==="(")t+=1;if(r[s]===
")")if(t===0)return{result:v,iter:u};else t-=1;v.push(r[s])}};j=a.length;for(c=-1;(c+=1)<j;)if(a[c]==="("||a[c]==="!("){if(a[c].substring(0,1)==="!"){p=true;a[c]=a[c].substring(1)}else p=false;l=k(a.slice(c+1),c);n=l.result.join(" ");c=l.iter;if(n.search(/^:/)!==-1){if(!this._exist("filter","__tmp:"+n)){this._push("filter","__tmp:"+n,this._compileFilter(n));l.result=this._compileFilter(n)}l.result=this._get("filter","__tmp:"+n)}n=this._customFilter(l.result,b,c,e,g,f,h);m=!o&&!q?p===true?!n:n:o?p===
true?!n:n&&m:p===true?!n:n||m}else if(a[c]!==")"&&a[c]!=="||"&&a[c]!=="&&"){if(a[c].substring(0,1)==="!"){p=true;a[c]=a[c].substring(1)}else p=false;n=this._get("filter",a[c]).call(this._get("filter",a[c]),b,c,e,g,f,h);m=!o&&!q?p===true?!n:n:o?p===true?!n:n&&m:p===true?!n:n||m}else if(a[c]==="||"){o=false;q=true}else if(a[c]==="&&"){q=false;o=true}return m}};d.Collection.prototype._compileFilter=function(a){var b=/^\s*\(*\s*/.exec(a);if(b.length!==0)a=a.substring(b[0].length+1,a.length-b[0].length);
a=a.split("<:").join('self.getVariable("').split(":>").join('")');return new Function("el","i","data","cOLength","self","id","var key = i; return "+a.replace(/^\s*:/,"")+";")};d.Collection.prototype._customParser=function(a,b){if(a===false)return b;if(d.isFunction(a))return a.call(a,b,this);if(!a||d.isString(a)&&d.trim(a)===this.ACTIVE){if(this._get("parser")){if(d.isFunction(this._get("parser")))return this._get("parser").call(this._get("parser"),b,this);return this._customParser(this._get("parser"),
b)}}else{if(d.isString(a)){a=d.trim(a);if(a.search("&&")===-1)return this._customParser(this._get("parser",a),b);a=a.split("&&")}a.forEach(function(c){c=d.trim(c);b=this._get("parser",c).call(this._get("parser",c),b,this)},this)}return b};d.Collection.prototype.parentContext=function(a,b){for(var c=this._get("context",b||"").split(nimble.CHILDREN),e=a||1;(e-=1)>-1;)c.splice(-1,1);return c.join(nimble.CHILDREN)};d.Collection.prototype.parent=function(a,b){if(!b)return this._update("context",this.parentContext.apply(this,
arguments));return this._push("context",b,this.parentContext.apply(this,arguments))};d.Collection.prototype._getActiveParam=function(a){var b=this.dObj.sys.flags.use[a]===undefined||this.dObj.sys.flags.use[a]===true?this.dObj.active[a]:false;if(a==="context")return b?b.toString():"";return b};d.Collection.prototype._filterTest=function(a){return a===this.ACTIVE||this._exist("filter",a)||a.search(/&&|\|\||:/)!==-1};d.Collection.prototype.enable=function(a){this.dObj.sys.flags.use[a]=true;return this};
d.Collection.prototype.disable=function(a){this.dObj.sys.flags.use[a]=false;return this};d.Collection.prototype.toggle=function(a){if(this.dObj.sys.flags.use[a]===true)return this.disable(a);return this.enable(a)};d.Collection.prototype.toString=function(a,b,c){if(!JSON||!JSON.stringify)throw Error("object JSON is not defined!");b=b||"";c=c||"";if(a&&(d.isArray(a)||d.isPlainObject(a)))return JSON.stringify(a,b,c);return JSON.stringify(nimble.byLink(this._get("collection",a||""),this._getActiveParam("context")),
b,c)};d.Collection.prototype.valueOf=function(){return this.length(this.ACTIVE)};d.Collection.prototype.then=function(a,b){var c=this;arguments.length===1?d.when(this.active("defer")).always(function(){a.apply(c,arguments)}):d.when(this.active("defer")).then(function(){a().apply(c,arguments)},function(){b().apply(c,arguments)});return this};d.Collection.prototype.print=function(a,b,c){b=b||false;c=c||false;var e={},g,f,h=0,j=null,k="",l;if(d.isExist(a)&&(d.isString(a)||d.isNumeric(a)))a={page:a};
else if(d.isBoolean(a))b=a;else d.isExist(a)||(a={page:this._get("page")});d.extend(true,e,this.dObj.active,a);if(a)e.page=nimble.expr(e.page,this._get("page"));if(e.page<1)e.page=1;e.collection=d.isString(e.collection)?this._get("collection",e.collection):e.collection;e.template=d.isString(e.template)?this._get("template",e.template):e.template;e.filter=d.isExist(a.filter)&&a.filter!==true?a.filter:this._getActiveParam("filter");e.parser=d.isExist(a.parser)?a.parser:this._getActiveParam("parser");
if(c===true)e.cache.iteration=false;c=this._get("page")-e.page;this.updatePage(e.page);l=function(m,n,o,q,p,r){e.callback&&e.callback.apply(this,arguments);k+=e.template.call(e.template,m,n,o,q,p,r);h=n;return true};a=nimble.byLink(e.collection,this._getActiveParam("context")+nimble.CHILDREN+(a&&a.context||""));g=this.length();e.numberBreak=!b||e.numberBreak===false?g:e.numberBreak;if(d.isPlainObject(a)||e.cache.iteration===false||e.cache.firstIteration===false||e.cache.lastIteration===false){f=!b||
e.page===1?0:(e.page-1)*e.numberBreak;this.forEach(l,e.filter,this.ACTIVE,true,e.numberBreak,f);if(e.cache.iteration===false)e.cache.lastIteration=false}else if(d.isArray(a)&&e.cache.iteration===true){f=!b||e.filter===false?e.page===1?0:(e.page-1)*e.numberBreak:e.cache.iteration===true?c>=0?e.cache.firstIteration:e.cache.lastIteration:i;if(c>0&&b===true&&e.filter!==false){for(c*=e.numberBreak;(f-=1)>-1;)if(this._customFilter(e.filter,a[f],a,f,g,this,this.ACTIVE)===true)if(h===c)break;else h+=1;e.cache.lastIteration=
f+=1;j=null}else if(c<0&&b===true&&e.filter!==false)j=Math.abs(c)*e.numberBreak-e.numberBreak||null;this.forEach(l,e.filter,this.ACTIVE,true,e.numberBreak,j,f)}if(c!==0&&e.cache.iteration!==false){this._get("cache").firstIteration=e.cache.lastIteration;this._get("cache").lastIteration=h+1}if(e.cache.autoIteration===true)this._get("cache").iteration=true;k=!k?e.resultNull:this._customParser(e.parser,k);if(e.target===false){e.variable?this._push("variable",e.variable,k):this._new("variable",k);return this}else e.target[e.appendType](k);
if(!b)return this;e.nmbOfEntries=e.filter!==false?this.length(e.filter):g;e.nmbOfEntriesInPage=e.target.find(e.calculator).length;e.finNumber=e.numberBreak*e.page-(e.numberBreak-e.nmbOfEntriesInPage);e.page!==1&&e.nmbOfEntriesInPage===0?this.updatePage(e.page-=1).print(e,true,true):this.easyPage(e);return this};d.Collection.prototype.easyPage=function(a){var b="",c=a.nmbOfEntries%a.numberBreak!==0?~~(a.nmbOfEntries/a.numberBreak)+1:a.nmbOfEntries/a.numberBreak,e=function(k,l,m){var n,o="<"+(k.tag||
"span")+' data-page="'+m+'"';if(k.attr)for(n in k.attr)if(k.attr.hasOwnProperty(n))o+=" "+n+'="'+k.attr[n]+'"';if(m===a.page)o+=' class="'+(l&&l.active||"active")+'"';return o+(">"+m+"</"+(k.tag||"span")+">")},g,f=0,h,j;a.pager.find("[data-ctm]").each(function(){if(a.pageBreak<=2)throw Error('parameter "pageBreak" must be more than 2');var k=d(this),l=k.data("ctm"),m=l.classes;if(l.nav){if(l.nav==="prev"&&a.page===1||l.nav==="next"&&a.finNumber===a.nmbOfEntries)k.addClass(m&&m.disabled||"disabled");
else if(l.nav==="prev"||l.nav==="next")k.removeClass(m&&m.disabled||"disabled");if(l.nav==="pageList"){if(c>a.pageBreak){f=a.pageBreak%2!==0?1:0;j=h=(a.pageBreak-f)/2;if(a.page-f<h)h=0;else{h=a.page-h-f;if(a.page+j>c)h-=a.page+j-c}g=h;for(f=-1;(g+=1)<=c&&(f+=1)!==null;){if(f===a.pageBreak&&g!==a.page)break;b+=e(l,m||"",g)}}else for(g=0;(g+=1)<=c;)b+=e(l,m||"",g);k.html(b)}}else if(l.info){a.nmbOfEntriesInPage===0?k.addClass(m&&m.noData||"noData"):k.removeClass(m&&m.noData||"noData");switch(l.info){case "page":k.html(a.page);
break;case "total":k.html(a.nmbOfEntries);break;case "from":k.html((a.page-1)*a.numberBreak+1);break;case "to":k.html(a.finNumber);break;case "inPage":k.html(a.nmbOfEntriesInPage);break;case "nmbOfPages":k.html(a.nmbOfPages)}}});return this};d.Collection.prototype.genTable=function(a,b,c){a=a||4;b=b||"div";c=c===false?false:true;var e=1,g,f=this._get("target"),h=f.find(b).length,j="";f.find(b).each(function(k){this.tagName!=="td"&&d(this).wrap("<td></td>");if(e===a){j="";for(g=-1;(g+=1)<a;){j+="td:eq("+
(k-g)+")";if(g!==a-1)j+=","}f.find(j).wrapAll("<tr></tr>");e=0}else if(k===h-1&&e!==a){j="";for(g=-1;(g+=1)<e;){j+="td:eq("+(k-g)+")";if(g!==e-1)j+=","}e-=1;f.find(j).wrapAll("<tr></tr>");if(c===true){for(j="";(e+=1)<a;)j+="<td></td>";f.find("tr:last").append(j)}}e+=1});f[0].tagName!=="table"&&f.children("tr").wrapAll("<table></table>");return this}})(jQuery);
//