/**
 * $.Collection
 * 
 * autor: kobezzza (kobezzza@gmail.com | http://kobezzza.com)
 * version: 3.5
 * date: 19.02.2012 13:24:31
 */
 var nimble=function(){return{name:"nimble",version:"1.0.2",nimble:function(){return this.name+" "+this.version},CONTEXT_SEPARATOR:" ",QUERY_SEPARATOR:"/",SUBQUERY_SEPARATOR:"{",METHOD_SEPARATOR:"->",CHILDREN:">",ORDER:["eq(",")"],trim:function(d){d=d.replace(/^\s\s*/,"");for(var a=/\s/,b=d.length;a.test(d.charAt(b-=1)););return d.substring(0,b+1)},isString:function(d){return Object.prototype.toString.call(d)==="[object String]"},isNumber:function(d){return Object.prototype.toString.call(d)==="[object Number]"},
isArray:function(d){return Object.prototype.toString.call(d)==="[object Array]"},isExists:function(d){return d!==undefined&&d!=="undefined"&&d!==null&&d!==""},expr:function(d,a){a=a!==undefined||a!==null?a:"";if(this.isString(d)&&d.search(/^[+-\\*\/]{1}=/)!==-1){d=d.split("=");isNaN(d[1])||(d[1]=+d[1]);switch(d[0]){case "+":d=a+d[1];break;case "-":d=a-d[1];break;case "*":d=a*d[1];break;case "/":d=a/d[1]}}return d},byLink:function(d,a,b,c){a=a.toString().replace(RegExp("\\s*"+this.CHILDREN+"\\s*",
"g")," "+this.CHILDREN+" ").split(this.CONTEXT_SEPARATOR);c=c||false;for(var f=this.CHILDREN,e=0,g=0,h,j=a.length,k,i;(j-=1)>-1;){a[j]=this.trim(a[j]);if(a[j]===""){a.splice(j,1);e-=1}else if(a[j]!==this.CHILDREN){if(j>e)e=j;g+=1}}i=a.length;if(d===false)return a.join("");else if(this.isNumber(d)){if((d=+d)<0)d+=g;if(b===undefined){j=-1;for(k=0;(j+=1)<i;)if(a[j]!==this.CHILDREN)if((k+=1)===d){a.splice(j+1,i);return a.join("")}}else{j=i;for(k=0;(j-=1)>-1;)if(a[j]!==this.CHILDREN)if((k+=1)===d){a.splice(0,
j);return a.join("")}}}for(j=-1;(j+=1)<i;)switch(a[j]){case this.CHILDREN:f=a[j];break;default:if(f===this.CHILDREN&&a[j].substring(0,this.ORDER[0].length)!==this.ORDER[0])if(j===e&&b!==undefined)if(c===false)d[a[j]]=this.expr(b,d[a[j]]);else if(nimble.isArray(d))d.splice(a[j],1);else delete d[a[j]];else d=d[a[j]];else{g=a[j].substring(this.ORDER[0].length);g=g.substring(0,g.length-1);g=+g;if(this.isArray(d))if(j===e&&b!==undefined)if(g>=0)if(c===false)d[g]=this.expr(b,d[g]);else d.splice(g,1);else if(c===
false)d[d.length+g]=this.expr(b,d[d.length+g]);else d.splice(d.length+g,1);else d=g>=0?d[g]:d[d.length+g];else{if(g<0){k=0;for(h in d)if(d.hasOwnProperty(h))k+=1;g+=k}k=0;for(h in d)if(d.hasOwnProperty(h)){if(g===k){if(j===e&&b!==undefined)if(c===false)d[h]=this.expr(b,d[h]);else delete d[h];else d=d[h];break}k+=1}}}}if(b!==undefined)return this;return d},execEvent:function(d,a,b,c){d=d.split(this.QUERY_SEPARATOR);b=this.isExists(b)?b:[];b=this.isArray(b)?b:[b];for(var f=-1,e=d.length-1;(f+=1)<e;)a=
a[d[f]];if(d[f].search(this.SUBQUERY_SEPARATOR)!==-1){d=d[f].split(this.SUBQUERY_SEPARATOR);a=a[d[0]];d.splice(0,1);b=b.concat(d);return a.apply(c||a,b)}else return a[d[f]].apply(c||a,b)},addElementToObject:function(d,a,b){a=a.split(this.METHOD_SEPARATOR);var c,f={};if(a[1]&&a[1]=="unshift"){f[!isNaN(Number(a[0]))?0:a[0]]=b;for(c in d)if(d.hasOwnProperty(c))f[!isNaN(Number(c))?+c+1:c]=d[c];return f}else if(!a[1]||a[1]=="push")d[a[0]]=b;return true}}}();
(function(d){d.Collection=function(a,b){a=a||"";b=b||"";if(this.fn&&(!this.fn.name||this.fn.name!=="$.Collection"))return new d.Collection(a,b);d.extend(true,this,d.Collection.storage);var c=this.dObj.active;b&&d.extend(true,c,b);if(this._exprTest(c.filter))c.filter=this._compileFilter(c.filter);if(this._exprTest(c.parser))c.parser=this._compileParser(c.parser);if(d.isString(a)){c.target=d(a);c.collection=null}else c.collection=a};if(!Array.prototype.forEach)Array.prototype.forEach=function(a,b){for(var c=
-1,f=this.length;(c+=1)<f;)b?a.call(b,this[c],c,this):a(this[c],c,this)};if(!Array.prototype.some)Array.prototype.some=function(a,b){for(var c=-1,f=this.length,e;(c+=1)<f;){e=b?a.call(b,this[c],c,this):a(this[c],c,this);if(e===true)break}};d.Collection.prototype={name:"$.Collection",version:"3.5",collection:function(){return this.name+" "+this.version},ACTIVE:"active",SHUFFLE:"shuffle",NAMESPACE_SEPARATOR:".",stack:["namespace","collection","filter","context","cache","variable","defer","page","parser",
"appendType","target","calculator","pager","template","numberBreak","pageBreak","resultNull"]};d.fn=d.fn;d.fn.collection=function(a){var b=d.fn.collection.stat,c=function(g){g=g.childNodes;for(var h=g.length,j=-1,k="";(j+=1)<h;)if(g[j].nodeType===3&&d.trim(g[j].textContent))k+=g[j].textContent;if(k)return k;return false},f=function(g){var h=[];g.each(function(j){var k=d(this),i=k.data(),l=k.attr("class")?k.attr("class").split(" "):"",m=c(this),n;h.push({});for(n in i)if(i.hasOwnProperty(n))h[j][n]=
i[n];if(l){h[j][b.classes]={};l.forEach(function(o){h[j][b.classes][o]=o})}if(k.children().length!==0)h[j][b.childNodes]=f(k.children());if(m!==false)h[j][b.val]=m.replace(/[\r\t\n]/g," ")});return h},e=f(this);if(a)return new d.Collection(e,a);return new d.Collection(e)};if(!d.fn.collection.stat)d.fn.collection.stat={val:"val",childNodes:"childNodes",classes:"classes"};d.fn.ctplCompile=function(){if(this.length===0)throw Error("DOM element does't exist!");var a="var key = i, result = ''; ";this.html().replace(/\/\*.*?\*\//g,
"").split("?>").join("<?js").replace(/[\r\t\n]/g," ").split("<?js").forEach(function(b,c){a+=c===0||c%2===0?"result +='"+b+"';":b.split("echo").join("result +=")});return new Function("el","i","data","cOLength","cObj","id",a+" return result;")};d.fn.ctplMake=function(a){this.each(function(){var b=d(this),c=b.data("ctpl"),f,e=c.prefix?c.prefix+"_":"";if(d.isString(c))c=d.parseJSON(c);a._push("template",e+c.name,b.ctplCompile());c.set&&c.set===true&&a._set("template",e+c.name);for(f in c)if(c.hasOwnProperty(f))if(!(f===
"prefix"||f==="set"||f==="print"||f==="name")){if(f==="target"||f==="pager")c[f]=d(c[f]);a._push(f,e+c.name,c[f]);c.set&&c.set===true&&a._set(f,e+c.name);if(f==="filter"||f==="parser")c[f]=e+c.name}if(c.print&&c.print===true){c.template=c.name;a.print(c)}});return this};d.isString=function(a){return nimble.isString(a)};d.isBoolean=function(a){return Object.prototype.toString.call(a)==="[object Boolean]"};d.isExists=function(a){return nimble.isExists(a)};d.unshiftArguments=function(a,b){for(var c=
[b],f=-1,e=a.length;(f+=1)<e;)c.push(a[f]);return c};d.toUpperCase=function(a,b,c){c=c||0;b=d.isExists(b)?c+b:a.length;return a.substring(0,c)+a.substring(c,b).toUpperCase()+a.substring(b)};d.toLowerCase=function(a,b,c){c=c||0;b=d.isExists(b)?c+b:a.length;return a.substring(0,c)+a.substring(c,b).toLowerCase()+a.substring(b)};d.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};d.Collection.storage={dObj:{active:{namespace:"nm",collection:null,filter:false,context:"",cache:{autoIteration:true,
iteration:true,firstIteration:false,lastIteration:false},variable:null,defer:"",page:1,parser:false,appendType:"html",target:null,calculator:null,pager:null,template:null,numberBreak:10,pageBreak:10,resultNull:""}}};d.Collection.storage.dObj.sys={flags:{use:{context:true,filter:true,parser:true,cache:false}}};(function(a){var b,c=d.Collection.storage.dObj.sys;a.forEach(function(f){b=d.toUpperCase(f,1);c["active"+b+"ID"]=null;c["tmp"+b]={};c[f+"ChangeControl"]=null;c[f+"Back"]=[]})})(d.Collection.prototype.stack);
d.Collection.prototype._new=function(a,b){var c=this.dObj.active,f=d.toUpperCase(a,1);c[a]=(a==="filter"||a==="parser")&&this._exprTest(b)?this["_compile"+d.toUpperCase(a,1)](b):nimble.expr(b,c[a]||"");this.dObj.sys["active"+f+"ID"]=null;return this};d.Collection.prototype._update=function(a,b){var c=this.dObj.active,f=this.dObj.sys,e=this._getActiveID(a);c[a]=(a==="filter"||a==="parser")&&this._exprTest(b)?this["_compile"+d.toUpperCase(a,1)](b):nimble.expr(b,c[a]||"");if(e)f["tmp"+d.toUpperCase(a,
1)][e]=c[a];return this};d.Collection.prototype._get=function(a,b){if(b&&b!==this.ACTIVE){if(!this._exists(a,b))throw Error('the object "'+b+'" -> "'+a+"\" doesn't exist in the stack!");return this.dObj.sys["tmp"+d.toUpperCase(a,1)][b]}return this.dObj.active[a]};d.Collection.prototype._push=function(a,b,c){var f=this.dObj.sys["tmp"+d.toUpperCase(a,1)],e=this._getActiveID(a),g;if(d.isPlainObject(b))for(g in b){if(b.hasOwnProperty(g))if(g===this.ACTIVE)this._update(a,b[g]);else if(f[g]&&e&&e===g)this._update(a,
b[g]);else f[g]=(a==="filter"||a==="parser")&&this._exprTest(b[g])?this["_compile"+d.toUpperCase(a,1)](b[g]):b[g]}else if(b===this.ACTIVE)this._update(a,c);else if(f[b]&&e&&e===b)this._update(a,c);else f[b]=(a==="filter"||a==="parser")&&this._exprTest(c)?this["_compile"+d.toUpperCase(a,1)](c):c;return this};d.Collection.prototype._set=function(a,b){var c=this.dObj.sys,f=d.toUpperCase(a,1),e=a+"ChangeControl",g="active"+f+"ID";if(!this._exists(a,b))throw Error('the object "'+b+'" -> "'+a+"\" doesn't exist in the stack!");
if(c[g]!==b){c[e]=true;c[g]=b}else c[e]=false;c[a+"Back"].push(b);this.dObj.active[a]=c["tmp"+f][b];return this};d.Collection.prototype._back=function(a,b){var c=this.dObj.sys,f=d.toUpperCase(a,1),e=c[a+"Back"],g=e.length-(b||1)-1;if(g>=0&&e[g])if(c["tmp"+f][e[g]]){this._set(a,e[g]);c[a+"ChangeControl"]=false;e.splice(g+1,e.length)}return this};d.Collection.prototype._backIf=function(a){if(this.dObj.sys[a+"ChangeControl"]===true)return this._back.apply(this,arguments);return this};d.Collection.prototype._drop=
function(a,b,c,f){c=c===undefined?false:c;var e=this.dObj.active,g=this.dObj.sys,h=d.toUpperCase(a,1),j="active"+h+"ID";h="tmp"+h;var k=this._getActiveID(a);b=!b?k?[k]:[]:d.isArray(b)||d.isPlainObject(b)?b:[b];var i;if(b[0]&&b[0]!==this.ACTIVE)for(i in b){if(b.hasOwnProperty(i))if(!b[i]||b[i]===this.ACTIVE)if(f===undefined){k&&delete g[h][k];g[j]=null;e[a]=c}else{if(k)g[h][k]=f;e[a]=f}else if(f===undefined){delete g[h][b[i]];if(k&&b[i]===k){g[j]=null;e[a]=c}}else{g[h][b[i]]=f;if(k&&b[i]===k)e[a]=
f}}else if(f===undefined){k&&delete g[h][k];g[j]=null;e[a]=c}else{if(k)g[h][k]=f;e[a]=f}return this};d.Collection.prototype._reset=function(a,b,c){return this._drop(a,b||"","",c===undefined?false:c)};d.Collection.prototype._resetTo=function(a,b,c){c=!c||c===this.ACTIVE?this.dObj.active[a]:this.dObj.sys["tmp"+d.toUpperCase(a,1)][c];return this._reset(a,b||"",c)};d.Collection.prototype._exists=function(a,b){var c=d.toUpperCase(a,1);if((!b||b===this.ACTIVE)&&this._getActiveID(a))return true;if(this.dObj.sys["tmp"+
c][b]!==undefined)return true;return false};d.Collection.prototype._getActiveID=function(a){return this.dObj.sys["active"+d.toUpperCase(a,1)+"ID"]};d.Collection.prototype._active=function(a,b){if(!b)return this._getActiveID(a);if(b===this._getActiveID(a))return true;return false};d.Collection.prototype.use=function(a){this.stack.forEach(function(b){var c,f,e;if(this._exists(b,a))this._set(b,a);else{c=a.split(this.NAMESPACE_SEPARATOR);for(e=c.length;(e-=1)>-1;){c.splice(e,1);f=c.join(this.NAMESPACE_SEPARATOR);
if(this._exists(b,f)){this._set(b,f);break}}}},this);return this};d.Collection.prototype._prop=function(a,b,c){var f=this.dObj[a];if(arguments.length!==3)if(d.isPlainObject(b))d.extend(f,b);else return f[b];else f[b]=c;return this};d.Collection.prototype.active=function(){return this._prop.apply(this,d.unshiftArguments(arguments,"active"))};(function(a){var b=d.Collection.prototype,c;a.forEach(function(f){c=d.toUpperCase(f,1);b["new"+c]=function(e){return function(g){return this._new(e,g)}}(f);b["update"+
c]=function(e){return function(g){return this._update(e,g)}}(f);b["reset"+c+"To"]=function(e){return function(g,h){return this._resetTo(e,g,h)}}(f);b["push"+c]=function(e){return function(){return this._push.apply(this,d.unshiftArguments(arguments,e))}}(f);b["set"+c]=function(e){return function(g){return this._set(e,g)}}(f);b["pushSet"+c]=function(e){return function(g,h){return this._push(e,g,h)._set(e,g)}}(f);b["back"+c]=function(e){return function(g){return this._back(e,g||"")}}(f);b["back"+c+"If"]=
function(e){return function(g){return this._backIf(e,g||"")}}(f);b["drop"+c]=f==="filter"||f==="parser"?function(e){return function(){return this._drop(e,arguments)}}(f):function(e){return function(){return this._drop(e,arguments,null)}}(f);if(f==="filter"||f==="parser")b["reset"+c]=function(e){return function(){return this._reset(e,arguments)}}(f);else if(f==="page")b["reset"+c]=function(e){return function(){return this._reset(e,arguments,1)}}(f);else if(f==="context")b["reset"+c]=function(e){return function(){return this._reset(e,
arguments,"")}}(f);b["active"+c]=function(e){return function(g){return this._active(e,g)}}(f);b["exists"+c]=function(e){return function(g){return this._exists(e,g||"")}}(f);b["get"+c+"ActiveID"]=function(e){return function(){return this._getActiveID(e)}}(f);b["get"+c]=function(e){return function(g){return this._get(e,g||"")}}(f)})})(d.Collection.prototype.stack);d.Collection.prototype._setOne=function(a,b,c){a=d.isExists(a)?a.toString():"";b=b===undefined?"":b;c=c||"";var f=this._getActiveParam("context");
if(!a&&!f)return c&&c!==this.ACTIVE?this._push("collection",c,b):this._update("collection",b);nimble.byLink(this._get("collection",c),f+nimble.CHILDREN+a,b);return this};d.Collection.prototype._getOne=function(a,b){a=d.isExists(a)?a.toString():"";return nimble.byLink(this._get("collection",b||""),this._getActiveParam("context")+nimble.CHILDREN+a)};d.Collection.prototype.add=function(a,b,c,f,e){a=a!==undefined?a:"";b=b||"push";c=c||"";e=e||false;var g,h,j;g=nimble.byLink(this._get("collection",c),
this._getActiveParam("context"));if(typeof g==="object"){if(f){a=d.isExists(a)?a.toString():"";h=nimble.byLink(this._get("collection",f||""),a);if(d.isPlainObject(g)){b=b==="push"?this.length(g):b==="unshift"?this.length(g)+nimble.METHOD_SEPARATOR+"unshift":b;j=nimble.addElementToObject(g,b.toString(),h)}else{j=true;g[b](h)}e===true&&this.disable("context")._removeOne(a,f).enable("context")}else if(d.isPlainObject(g)){b=b==="push"?this.length(g):b==="unshift"?this.length(g)+nimble.METHOD_SEPARATOR+
"unshift":b;j=nimble.addElementToObject(g,b.toString(),a)}else{j=true;g[b](a)}j!==true&&this._setOne("",j,c)}else throw Error("unable to set property!");return this};d.Collection.prototype.push=function(a,b){return this.add(a,"",b||"")};d.Collection.prototype.unshift=function(a,b){return this.add(a,"unshift",b||"")};d.Collection.prototype._removeOne=function(a,b){a=d.isExists(a)?a.toString():"";var c=this._getActiveParam("context");!a&&!c?this._setOne("",null):nimble.byLink(this._get("collection",
b||""),c+nimble.CHILDREN+a,"",true);return this};d.Collection.prototype._remove=function(a,b){b=b||"";var c,f;if(d.isPlainObject(a))for(c in a){if(a.hasOwnProperty(c))if(d.isArray(a[c]))for(f=a[c].length;(f-=1)>-1;)this._removeOne(a[c][f],c);else this._removeOne(a[c],c)}else if(d.isArray(a))for(f=a.length;(f-=1)>-1;)this._removeOne(a[f],b);else this._removeOne(a,b);return this};d.Collection.prototype.pop=function(a){return this._removeOne("eq(-1)",a||"")};d.Collection.prototype.shift=function(a){return this._removeOne("eq(0)",
a||"")};d.Collection.prototype.concat=function(a,b,c){b=d.isExists(b)?b.toString():"";c=c||"";var f=nimble.byLink(this._get("collection",c),this._getActiveParam("context")+nimble.CHILDREN+b);if(typeof f==="object")if(d.isPlainObject(f))d.extend(true,f,a);else{if(d.isArray(f))if(d.isArray(a)){f=Array.prototype.concat(f,a);this._setOne(b,f,c)}else this.add(a,"push",c)}else throw Error("incorrect data type!");return this};d.Collection.prototype.length=function(a,b){a=a||"";var c={},f,e,g,h;if(!d.isFunction(a))if(d.isString(a)&&
!this._filterTest(a)&&!d.isExists(b)||d.isArray(a)||d.isPlainObject(a)){b=a;a=false}if(b)if(d.isString(b))f=this._get("collection",b);else{e=true;f=b}else f=this._get("collection");if(f===null)return 0;if(e!==true)f=nimble.byLink(f,this._getActiveParam("context"));if(d.isString(f))return f.length;if(typeof f!=="object")throw Error("incorrect data type!");if(a===false&&f.length!==undefined)h=f.length;else{h=0;if(f.length!==undefined)f.forEach(function(j,k){if(this._customFilter(a,j,k,f,h||null,this,
b?b:this.ACTIVE,c)===true)h+=1},this);else for(g in f)if(f.hasOwnProperty(g))if(this._customFilter(a,f[g],g,f,h||null,this,b?b:this.ACTIVE,c)===true)h+=1}c.name&&this._drop("filter","__tmp:"+c.name);return h};d.Collection.prototype.forEach=function(a,b,c,f,e,g,h){a=d.isFunction(a)?{filter:a}:a;b=b||"";if(d.isBoolean(c)){h=g;g=e;e=f;f=c;c=this.ACTIVE}else c=c||"";f=f===false?false:true;e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;h=parseInt(h)||false;var j=this,k={},i,l,m,n=0,o=false,p;
i=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(typeof i!=="object")throw Error("incorrect data type!");l=function(){if(!l.val)l.val=j.length(b,c);return l.val};if(d.isArray(i)){m=h!==false?i.slice(h):i;m.some(function(r,q){q+=h;if(e!==false&&n===e)return true;if(this._customFilter(b,r,q,i,l,this,c,k)===true)if(g!==false&&g!==0)g-=1;else{if(a.filter)o=a.filter.call(a.filter,r,q,i,l,this,c)===false;if(f===false)o=true;n+=1}else if(a.denial&&(g===false||g===0)){p=a.denial.call(a.denial,
r,q,i,l,this,c);if(o===false&&p===false)o=true}if(a.full&&(g===false||g===0)){p=a.full.call(a.full,r,q,i,l,this,c);if(o===false&&p===false)o=true}if(o===true)return true;p=""},this)}else for(m in i)if(i.hasOwnProperty(m)){if(e!==false&&n===e)break;if(h!==false&&h!==0)h-=1;else{if(this._customFilter(b,i[m],m,i,l,this,c,k)===true)if(g!==false&&g!==0)g-=1;else{if(a.filter)o=a.filter.call(a.filter,i[m],m,i,l,this,c)===false;if(f===false)o=true;n+=1}else if(a.denial&&(g===false||g===0)){p=a.denial.call(a.denial,
i[m],m,i,l,this,c);if(o===false&&p===false)o=true}if(a.full&&(g===false||g===0)){p=a.full.call(a.full,i[m],m,i,l,this,c);if(o===false&&p===false)o=true}if(o===true)break;p=""}}k.name&&this._drop("filter","__tmp:"+k.name);l=null;return this};d.Collection.prototype.search=function(a,b,c,f,e,g){if(d.isBoolean(b)){g=e;e=f;f=c;c=b;b=this.ACTIVE}else b=b||"";c=c===false?false:true;f=parseInt(f)>=0?parseInt(f):false;e=parseInt(e)||false;g=parseInt(g)||false;var h=c===true?[]:-1;this.forEach(function(j,k){if(c===
true)h.push(k);else h=k;return true},a||"",b,c,f,e,g);return h};d.Collection.prototype.searchOne=function(a,b){return this.search(a||"",b||"",false)};d.Collection.prototype.indexOf=function(a,b,c){c=c||"";b=b||"";var f=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(d.isArray(f)&&f.indexOf){if(b)return f.indexOf(a,b);return f.indexOf(a)}else return this.search(function(e){return e===a},c,false,"","",b)};d.Collection.prototype.lastIndexOf=function(a,b,c){c=c||"";b=b||"";
var f=nimble.byLink(this._get("collection",c),this._getActiveParam("context"));if(d.isArray(f)&&f.lastIndexOf){if(b)return f.lastIndexOf(a,b);return f.lastIndexOf(a)}else{b=this.search(function(e){return e===a},c,"","","",b);return b[b.length-1]!==undefined?b[b.length-1]:-1}};d.Collection.prototype.get=function(a,b,c,f,e,g){if(d.isNumeric(a)||arguments.length<2&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<2&&a===null)return this._getOne(a,b||"");if(d.isBoolean(b)){g=
e;e=f;f=c;c=b;b=this.ACTIVE}else b=b||"";c=c===false?false:true;f=parseInt(f)>=0?parseInt(f):false;e=parseInt(e)||false;g=parseInt(g)||false;var h=c===true?[]:-1;this.forEach(function(j,k,i){if(c===true)h.push(i[k]);else h=i[k];return true},a||"",b,c,f,e,g);return h};d.Collection.prototype.getOne=function(a,b){return this.get(a||"",b||"",false)};d.Collection.prototype.set=function(a,b,c){if(d.isNumeric(a)||arguments.length<3&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<
3&&a===null)return this._setOne(a,b,c||"");var f,e=d.isFunction(b);f=d.unshiftArguments(arguments,function(g,h,j,k,i,l){j[h]=e?b.call(b,g,h,j,k,i,l):nimble.expr(b,j[h]);return true});f.splice(2,1);return this.forEach.apply(this,f)};d.Collection.prototype.setOne=function(a,b,c){return this.set(a||"",b,c||"",false)};d.Collection.prototype.map=function(a,b,c){return this.set(b||"",a,c||"")};d.Collection.prototype.some=function(a,b,c){return this.forEach(a,b||"",c||"",false)};d.Collection.prototype.move=
function(a,b,c,f,e,g,h,j,k,i){a=a||"";i=i===false?false:true;b=d.isExists(b)?b.toString():"";c=c||"";f=f||"";e=e||"push";g=g===false?false:true;h=parseInt(h)>=0?parseInt(h):false;j=parseInt(j)||false;k=parseInt(k)||false;var l=[],m=d.isArray(nimble.byLink(this._get("collection",f),this._getActiveParam("context")));this.disable("context");a=this.search(a,c,g,h,j,k);this.enable("context");if(g===true)a.forEach(function(n){this.add(b+nimble.CHILDREN+n,m===true?e:n+nimble.METHOD_SEPARATOR+e,f,c);i===
true&&l.push(n)},this);else{this.add(b+nimble.CHILDREN+a,m===true?e:a+nimble.METHOD_SEPARATOR+e,f,c);i===true&&l.push(a)}i===true&&this.disable("context")._remove(l,c).enable("context");return this};d.Collection.prototype.moveOne=function(a,b,c,f,e){return this.move(a||"",d.isExists(b)?b.toString():"",c||"",f||"",e||"",false)};d.Collection.prototype.copy=function(a,b,c,f,e,g,h,j,k){g=g===false?false:true;h=parseInt(h)>=0?parseInt(h):false;j=parseInt(j)||false;k=parseInt(k)||false;return this.move(a||
"",d.isExists(b)?b.toString():"",c||"",f||"",e||"push",g,h,j,k,false)};d.Collection.prototype.copyOne=function(a,b,c,f,e){return this.move(a||"",d.isExists(b)?b.toString():"",c||"",f||"",e||"",false,"","","",false)};d.Collection.prototype.remove=function(a,b){if(d.isNumeric(a)||arguments.length<2&&d.isString(a)&&!this._filterTest(a)||arguments.length===0||arguments.length<2&&a===null)return this._removeOne(a,b||"");else if(d.isArray(a)||d.isPlainObject(a))return this._remove(a,b||"");var c=this.search.apply(this,
arguments),f;if(d.isArray(c))for(f=c.length;(f-=1)>-1;)this._removeOne(c[f],b);else this._removeOne(c,b);return this};d.Collection.prototype.removeOne=function(a,b){return this.remove(a||"",b||"",false)};d.Collection.prototype.group=function(a,b,c,f,e,g,h){a=this._exprTest(a=a||"")?this._compileFilter(a):a;c=c||"";h=h||false;f=parseInt(f)>=0?parseInt(f):false;e=parseInt(e)||false;g=parseInt(g)||false;var j=d.isString(a),k={};this.forEach(function(i,l){var m=j?nimble.byLink(i,a):a.apply(a,arguments);
if(k[m])k[m].push(!h?i:l);else k[m]=[!h?i:l];return true},b,c,"",f,e,g);return k};d.Collection.prototype.groupLinks=function(a,b,c,f,e,g){return this.group(a||"",b||"",c||"",f||"",e||"",g||"",true)};d.Collection.prototype.stat=function(a,b,c,f,e,g,h){a=a||"count";f=f||"";e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;h=parseInt(h)||false;var j=d.isString(a),k=0,i=0,l=function(m){m=nimble.byLink(m,b||"");switch(a){case "count":k+=1;break;case "summ":k+=m;break;case "avg":i+=1;k+=m;break;case "max":if(m>
k)k=m;break;case "min":if(i===0){k=m;i=1}else if(m<k)k=m;break;default:if(j)if(i===0){k=m;i=1}else k=nimble.expr(a+"="+m,k);else k=a(m,k)}return true};if(a!=="first"&&a!=="last"){this.forEach(l,c||"",f,"",e,g,h);if(a==="avg")k/=i}else k=a==="first"?this._getOne(nimble.ORDER[0]+"0"+nimble.ORDER[1]):this._getOne(nimble.ORDER[0]+"-1"+nimble.ORDER[1]);return k};d.Collection.prototype.groupStat=function(a,b,c,f,e,g,h){a=a||"count";f=f||"";e=parseInt(e)>=0?parseInt(e):false;g=parseInt(g)||false;h=parseInt(h)||
false;var j=d.isString(a),k={},i={},l,m=function(n){n=nimble.byLink(n,b||"");switch(a){case "count":k[this.i]+=1;break;case "summ":k[this.i]+=n;break;case "avg":i[this.i]+=1;k[this.i]+=n;break;case "max":if(n>k[this.i])k[this.i]=n;break;case "min":if(i[this.i]===0){k[this.i]=n;i[this.i]=1}else if(n<k[this.i])k[this.i]=n;break;default:if(j)if(i[this.i]===0){k[this.i]=n;i[this.i]=1}else k[this.i]=nimble.expr(a+"="+n,k[this.i]);else k[this.i]=a(n,k[this.i])}return true};this.forEach(function(n,o,p,r,
q,s){k[o]||(k[o]=i[o]=0);if(a!=="first"&&a!=="last")q._update("context","+="+nimble.CHILDREN+(m.i=o)).forEach(m,c||"",s,"",e,g,h).parent();else k[o]=a==="first"?nimble.byLink(n,nimble.ORDER[0]+"0"+nimble.ORDER[1]):nimble.byLink(n,nimble.ORDER[0]+"-1"+nimble.ORDER[1]);return true},"",f);if(a==="avg")for(l in k)if(k.hasOwnProperty(l))k[l]/=i[l];return k};d.Collection.prototype.sort=function(a,b,c,f){a=a||"";b=b||false;c=c&&c!==true?c===false?"":c:function(i){if(isNaN(i))return i.toUpperCase();return i};
f=f||"";var e=this,g,h=function(i,l){var m=b?-1:1;if(a){i=nimble.byLink(i,a);l=nimble.byLink(l,a)}if(c){i=c(i);l=c(l)}if(b!==e.SHUFFLE){if(i<l)return m*-1;if(i>l)return m;return 0}else return Math.floor(Math.random()*2-1)},j=function(i){var l=[],m={},n;for(n in i)i.hasOwnProperty(n)&&l.push(n);l.sort(h);for(n in l)if(l.hasOwnProperty(n))m[l[n]]=i[l[n]];return m},k=function(i){var l=[],m={},n;for(n in i)i.hasOwnProperty(n)&&l.push({key:n,value:i[n]});a=a===true?"value":"value"+nimble.CHILDREN+a;l.sort(h);
for(n in l)if(l.hasOwnProperty(n))m[l[n].key]=l[n].value;return m};g=nimble.byLink(this._get("collection",f),this._getActiveParam("context"));if(typeof g==="object")if(d.isArray(g))g.sort(h);else{g=a?k(g):j(g);this._setOne("",g,f)}else throw Error("incorrect data type!");return this};d.Collection.prototype.reverse=function(a){a=a||"";var b,c=function(f){var e=[],g={},h;for(h in f)f.hasOwnProperty(h)&&e.push(h);e.reverse();for(h in e)if(e.hasOwnProperty(h))g[e[h]]=f[e[h]];return g};b=nimble.byLink(this._get("collection",
a),this._getActiveParam("context"));if(typeof b==="object")d.isArray(b)?b.reverse():this._setOne("",c(b),a);else throw Error("incorrect data type!");return this};d.Collection.prototype.save=function(a,b){if(!localStorage)throw Error("your browser doesn't support web storage!");a=a||this.ACTIVE;var c="__"+this.name+"__"+this._get("namespace"),f=a===this.ACTIVE?this._exists("collection")?this._getActiveID("collection"):"":this._active("collection",a)?"active":"",e=b===false?sessionStorage:localStorage;
e.setItem(c+":"+a,this.toString(a));e.setItem(c+"__date:"+a,(new Date).toString());e.setItem(c+"__active:"+a,f);e.setItem(c+"__date",(new Date).toString());return this};d.Collection.prototype.saveAll=function(a){if(!localStorage)throw Error("your browser doesn't support web storage!");a=a===false?a:true;var b,c=this.dObj.sys.tmpCollection,f=false;this.dropAll(a);for(b in c){this._active("Collection",b)&&(f=true);c.hasOwnProperty(b)&&this.save(b,a)}f===false&&this.save("",a);return this};d.Collection.prototype.load=
function(a,b){if(!localStorage)throw Error("your browser doesn't support web storage!");a=a||this.ACTIVE;var c="__"+this.name+"__"+this._get("namespace"),f=b===false?sessionStorage:localStorage;a===this.ACTIVE?this._new("collection",d.parseJSON(f.getItem(c+":"+a))):this._push("collection",a,d.parseJSON(f.getItem(c+":"+a)));c=f.getItem(c+"__active:"+a);if(c===this.ACTIVE)this._set("collection",a);else c&&this._push("collection",c,this._get("collection"))._set("collection",c);return this};d.Collection.prototype.loadAll=
function(a,b){b=b?"drop":"load";if(!localStorage)throw Error("your browser doesn't support web storage!");a=a===false?a:true;var c="__"+this.name+"__"+this._get("namespace"),f=a===false?sessionStorage:localStorage,e=f.length,g,h;try{for(g in f)if(f.hasOwnProperty(g))if((h=g.split(":"))[0]===c)this[b](h[1],a)}catch(j){for(;(e-=1)>-1;)if((h=f[e].split(":"))[0]===c)this[b](h[1],a)}return this};d.Collection.prototype.loadDate=function(a,b){if(!localStorage)throw Error("your browser doesn't support web storage!");
return new Date((b===false?sessionStorage:localStorage).getItem("__"+this.name+"__"+this._get("namespace")+"__date"+(a?":"+a:"")))};d.Collection.prototype.isExpired=function(a,b,c){if(!localStorage)throw Error("your browser doesn't support web storage!");return new Date(new Date-new Date(this.loadDate(b||"",c||"")))>a};d.Collection.prototype.drop=function(a,b){if(!localStorage)throw Error("your browser doesn't support web storage!");a=a||this.ACTIVE;var c="__"+this.name+"__"+this._get("namespace"),
f=b===false?sessionStorage:localStorage;f.removeItem(c+":"+a);f.removeItem(c+"__date:"+a);f.removeItem(c+"__active:"+a);return this};d.Collection.prototype.dropAll=function(a){(a===false?sessionStorage:localStorage).removeItem("__"+this.name+"__"+this._get("namespace")+"__date");return this.loadAll(a||"",true)};d.Collection.prototype._customFilter=function(a,b,c,f,e,g,h,j){var k,i=true,l,m,n,o;if(!a){if(!this._getActiveParam("filter"))return true;if(this._get("filter"))return this._customFilter(this._get("filter"),
b,c,f,e,g,h,j);return true}if(d.isFunction(a))if(!this._getActiveParam("filter")||!j)return a.call(a,b,c,f,e,g,h);else{if(!j.name){for(;this._exists("filter","__tmp:"+(j.name=d.getRandomInt(0,1E4)));)j.name=d.getRandomInt(0,1E4);this._push("filter","__tmp:"+j.name,a)}return this._customFilter(this.ACTIVE+" && __tmp:"+j.name,b,c,f,e,g,h,j)}if(!d.isArray(a)){if(this._getActiveParam("filter")&&j)a=this.ACTIVE+" && ("+a+")";if(a.search(/\|\||&&|!/)===-1){if((a=d.trim(a)).search(/^(?:\(|)*:/)!==-1){this._exists("filter",
"__tmp:"+a)||this._push("filter","__tmp:"+a,this._compileFilter(a));return(a=this._get("filter","__tmp:"+a)).call(a,b,c,f,e,g,h)}return this._customFilter(this._get("filter",a),b,c,f,e,g,h,j)}a=d.trim(a.toString().replace(/\s*(\(|\))\s*/g," $1 ").replace(/\s*(\|\||&&)\s*/g," $1 ").replace(/(!)\s*/g,"$1")).split(" ");for(c=a.length;(c-=1)>-1;)a[c]===""&&a.splice(c,1)}k=function(p,r){for(var q=-1,s=p.length,t=0,u=[];(q+=1)<s;){r+=1;if(p[q]==="("||p[q]==="!(")t+=1;if(p[q]===")")if(t===0)return{result:u,
iter:r};else t-=1;u.push(p[q])}};j=a.length;for(c=-1;(c+=1)<j;)if(a[c]==="("||a[c]==="!("){if(a[c].substring(0,1)==="!"){o=true;a[c]=a[c].substring(1)}else o=false;c=(l=k(a.slice(c+1),c)).iter;l=l.result.join(" ");l=this._customFilter(l,b,c,f,e,g,h);i=!m&&!n?o===true?!l:l:m?o===true?!l:l&&i:o===true?!l:l||i}else if(a[c]!==")"&&a[c]!=="||"&&a[c]!=="&&"){if(a[c].substring(0,1)==="!"){o=true;a[c]=a[c].substring(1)}else o=false;l=this._customFilter(this._get("filter",a[c]),b,c,f,e,g,h);i=!m&&!n?o===true?
!l:l:m?o===true?!l:l&&i:o===true?!l:l||i}else if(a[c]==="||"){m=false;n=true}else if(a[c]==="&&"){n=false;m=true}return i};d.Collection.prototype._compileFilter=function(a){var b=/^\s*\(*\s*/.exec(a);if(b.length!==0)a=a.substring(b[0].length+1,a.length-b[0].length);a=a.split("<:").join('self.getVariable("').split(":>").join('")');return new Function("el","i","data","cOLength","cObj","id","var key = i; return "+a.replace(/^\s*:/,"")+";")};d.Collection.prototype._customParser=function(a,b,c){if(!a){if(!this._getActiveParam("parser"))return true;
if(this._get("parser"))return this._customParser(this._get("parser"),b,c);return true}if(d.isFunction(a))if(!this._getActiveParam("parser")||!c)return a.call(a,b,this);else{if(!c.name){for(;this._exists("parser","__tmp:"+(c.name=d.getRandomInt(0,1E4)));)c.name=d.getRandomInt(0,1E4);this._push("parser","__tmp:"+c.name,a)}return this._customParser(this.ACTIVE+" && __tmp:"+c.name,b,c)}if(d.isString(a)){if(this._getActiveParam("parser")&&c)a=this.ACTIVE+" && "+a;if((a=d.trim(a)).search("&&")===-1){if(a.search(/^(?:\(|)*:/)!==
-1){this._exists("parser","__tmp:"+a)||this._push("parser","__tmp:"+a,this._compileParser(a));return(a=this._get("parser","__tmp:"+a)).call(a,b,this)}return this._customParser(this._get("parser",a),b)}a=a.split("&&")}a.forEach(function(f){b=this._customParser(d.trim(f),b)},this);return b};d.Collection.prototype._compileParser=function(a){var b=/^\s*\(*\s*/.exec(a);if(b.length!==0)a=a.substring(b[0].length+1,a.length-b[0].length);a=a.split("<:").join('self.getVariable("').split(":>").join('")');return new Function("str",
"cObj","return "+a.replace(/^\s*:/,"")+";")};d.Collection.prototype.parentContext=function(a,b){for(var c=this._get("context",b||"").split(nimble.CHILDREN),f=a||1;(f-=1)>-1;)c.splice(-1,1);return c.join(nimble.CHILDREN)};d.Collection.prototype.parent=function(a,b){if(!b)return this._update("context",this.parentContext(a));return this._push("context",b,this.parentContext(a,b))};d.Collection.prototype._getActiveParam=function(a){var b=this.dObj.sys.flags.use[a]===undefined||this.dObj.sys.flags.use[a]===
true?this.dObj.active[a]:false;if(a==="context")return b?b.toString():"";return b};d.Collection.prototype._filterTest=function(a){return a===this.ACTIVE||this._exists("filter",a)||a.search(/&&|\|\||:/)!==-1};d.Collection.prototype._exprTest=function(a){return d.isString(a)&&a.search(/^:/)!==-1};d.Collection.prototype.enable=function(a){this.dObj.sys.flags.use[a]=true;return this};d.Collection.prototype.disable=function(a){this.dObj.sys.flags.use[a]=false;return this};d.Collection.prototype.toggle=
function(a){if(this.dObj.sys.flags.use[a]===true)return this.disable(a);return this.enable(a)};d.Collection.prototype.toString=function(a,b,c){if(!JSON||!JSON.stringify)throw Error("object JSON is not defined!");b=b||"";c=c||"";if(a&&(d.isArray(a)||d.isPlainObject(a)))return JSON.stringify(a,b,c);return JSON.stringify(nimble.byLink(this._get("collection",a||""),this._getActiveParam("context")),b,c)};d.Collection.prototype.valueOf=function(){return this.length(this.ACTIVE)};d.Collection.prototype.then=
function(a,b){var c=this;arguments.length===1?d.when(this.active("defer")).always(function(){a.apply(c,arguments)}):d.when(this.active("defer")).then(function(){a().apply(c,arguments)},function(){b().apply(c,arguments)});return this};d.Collection.prototype.print=function(a,b){b=b||false;var c={},f={},e={},g,h,j,k=0,i,l=null,m=false,n,o="",p;if(d.isExists(a)&&(d.isString(a)||d.isNumeric(a)))a={page:a};else d.isExists(a)||(a={page:this._get("page")});d.extend(true,e,this.dObj.active,a);if(a)e.page=
nimble.expr(e.page,this._get("page"));if(e.page<1)e.page=1;e.collection=d.isString(e.collection)?this._get("collection",e.collection):e.collection;e.template=d.isString(e.template)?this._get("template",e.template):e.template;e.cache=d.isExists(a.cache)?a.cache:this._getActiveParam("cache");if(b===true)e.cache.iteration=false;i=this._get("page")-e.page;this._update("page",e.page);p=function(r,q){e.callback&&e.callback.apply(e.callback,arguments);o+=e.template.apply(e.template,arguments);k=q;if(m===
false)m=q;return true};g=nimble.byLink(e.collection,this._getActiveParam("context")+nimble.CHILDREN+(a&&a.context||""));h=this.length();n=Boolean(e.numberBreak&&(e.filter||this._getActiveParam("filter")));e.numberBreak=e.numberBreak||h;if(d.isPlainObject(g)||!e.cache||e.cache.iteration===false||e.cache.firstIteration===false||e.cache.lastIteration===false){j=!n||e.page===1?0:(e.page-1)*e.numberBreak;this.forEach(p,e.filter,this.ACTIVE,true,e.numberBreak,j);if(e.cache&&e.cache.iteration===false)e.cache.lastIteration=
false}else if(d.isArray(g)&&e.cache.iteration===true){j=!n?e.page===1?0:(e.page-1)*e.numberBreak:i>=0?e.cache.firstIteration:e.cache.lastIteration;if(n)if(i>0){for(i*=e.numberBreak;(j-=1)>-1;)if(this._customFilter(e.filter,g[j],g,j,h,this,this.ACTIVE,f)===true)if(k===i)break;else k+=1;e.cache.lastIteration=j+=1;l=null}else if(i<0)l=-i*e.numberBreak-e.numberBreak;f.name&&this._drop("filter","__tmp:"+f.name);this.forEach(p,e.filter,this.ACTIVE,true,e.numberBreak,l,j)}if(e.cache){if(i!==0&&e.cache.iteration!==
false){this._get("cache").firstIteration=m;this._get("cache").lastIteration=k+1}if(e.cache.autoIteration===true)this._get("cache").iteration=true}o=!o?e.resultNull:this._customParser(e.parser,o,c);c.name&&this._drop("parser","__tmp:"+c.name);if(e.target===false){e.variable?this._push("variable",e.variable,o):this._new("variable",o);return this}else e.target[e.appendType](o);if(!e.pager)return this;e.nmbOfEntries=e.filter!==false?this.length(e.filter):h;e.nmbOfEntriesInPage=e.calculator?e.target.find(e.calculator).length:
e.target.children().length;e.finNumber=e.numberBreak*e.page-(e.numberBreak-e.nmbOfEntriesInPage);e.page!==1&&e.nmbOfEntriesInPage===0?this._update("page",e.page-=1).print(e,true,true):this.easyPage(e);return this};d.Collection.prototype.easyPage=function(a){var b=this,c="",f=a.nmbOfEntries%a.numberBreak!==0?~~(a.nmbOfEntries/a.numberBreak)+1:a.nmbOfEntries/a.numberBreak,e=function(i,l,m){var n,o="<"+(i.tag||"span")+' data-page="'+m+'"';if(i.attr)for(n in i.attr)if(i.attr.hasOwnProperty(n))o+=" "+
n+'="'+i.attr[n]+'"';if(m===a.page)o+=' class="'+(l&&l.active||"active")+'"';return o+(">"+m+"</"+(i.tag||"span")+">")},g,h=0,j,k;a.pager.find(".ctm").each(function(){if(a.pageBreak<=2)throw Error('parameter "pageBreak" must be more than 2');var i=d(this),l=i.data("ctm"),m=l.classes;if(l.nav){if((l.nav==="prev"||l.nav==="next")&&!i.data("ctm-delegated"))i.click(function(){if(!d(this).hasClass(l.classes&&l.classes.disabled||"disabled")){l.nav==="prev"&&(a.page="-=1");l.nav==="next"&&(a.page="+=1");
b.print(a)}}).data("ctm-delegated",true);if(l.nav==="prev"&&a.page===1||l.nav==="next"&&a.finNumber===a.nmbOfEntries)i.addClass(m&&m.disabled||"disabled");else if(l.nav==="prev"||l.nav==="next")i.removeClass(m&&m.disabled||"disabled");if(l.nav==="pageList"){if(f>a.pageBreak){h=a.pageBreak%2!==0?1:0;k=j=(a.pageBreak-h)/2;if(a.page-h<j)j=0;else{j=a.page-j-h;if(a.page+k>f)j-=a.page+k-f}g=j;for(h=-1;(g+=1)<=f&&(h+=1)!==null;){if(h===a.pageBreak&&g!==a.page)break;c+=e(l,m||"",g)}}else for(g=0;(g+=1)<=
f;)c+=e(l,m||"",g);i.html(c);i.data("ctm-delegated")||i.on("click",l.tag||"span",function(){var n=d(this);if(!n.hasClass(l.classes&&l.classes.active||"active")){a.page=n.data("page");b.print(a)}}).data("ctm-delegated",true)}}else if(l.info){a.nmbOfEntriesInPage===0?i.addClass(m&&m.noData||"noData"):i.removeClass(m&&m.noData||"noData");switch(l.info){case "page":i.html(a.page);break;case "total":i.html(a.nmbOfEntries);break;case "from":i.html((a.page-1)*a.numberBreak+1);break;case "to":i.html(a.finNumber);
break;case "inPage":i.html(a.nmbOfEntriesInPage);break;case "nmbOfPages":i.html(a.nmbOfPages)}}});return this};d.Collection.prototype.genTable=function(a,b,c){a=a||4;b=b||"div";c=c===false?false:true;var f=1,e,g=this._get("target"),h=g.find(b).length,j="";g.find(b).each(function(k){this.tagName!=="td"&&d(this).wrap("<td></td>");if(f===a){j="";for(e=-1;(e+=1)<a;){j+="td:eq("+(k-e)+")";if(e!==a-1)j+=","}g.find(j).wrapAll("<tr></tr>");f=0}else if(k===h-1&&f!==a){j="";for(e=-1;(e+=1)<f;){j+="td:eq("+
(k-e)+")";if(e!==f-1)j+=","}f-=1;g.find(j).wrapAll("<tr></tr>");if(c===true){for(j="";(f+=1)<a;)j+="<td></td>";g.find("tr:last").append(j)}}f+=1});g[0].tagName!=="table"&&g.children("tr").wrapAll("<table></table>");return this}})(jQuery);
//